name: Multi-Platform Release Build
'on':
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      version:
        description: Version tag (v1.0.0)
        required: true
env:
  CARGO_TERM_COLOR: always
  PROJECT_NAME: rustkpcli
jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: 'clippy, rustfmt'
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: '${{ runner.os }}-cargo-${{ hashFiles(''**/Cargo.lock'') }}'
      - name: Run tests
        run: cargo test --verbose
  build:
    name: 'Build for ${{ matrix.os }}-${{ matrix.arch }}'
    runs-on: '${{ matrix.os }}'
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            arch: x86_64
            extension: ''
          - os: ubuntu-latest
            target: i686-unknown-linux-gnu
            platform: linux
            arch: i686
            extension: ''
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            arch: x86_64
            extension: .exe
          - os: windows-latest
            target: i686-pc-windows-msvc
            platform: windows
            arch: i686
            extension: .exe
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            arch: x86_64
            extension: ''
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: macos
            arch: arm64
            extension: ''
          - os: ubuntu-latest
            target: aarch64-linux-android
            platform: android
            arch: aarch64
            extension: ''
          - os: ubuntu-latest
            target: armv7-linux-androideabi
            platform: android
            arch: armv7
            extension: ''
          - os: ubuntu-latest
            target: i686-linux-android
            platform: android
            arch: i686
            extension: ''
          - os: ubuntu-latest
            target: x86_64-linux-android
            platform: android
            arch: x86_64
            extension: ''
    steps:
      - uses: actions/checkout@v4
      - name: Install Linux dependencies
        if: runner.os == 'Linux' && matrix.platform != 'android'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config
          if [ "${{ matrix.arch }}" = "i686" ]; then
            sudo apt-get install -y gcc-multilib
          fi
      - name: Setup Android NDK
        if: matrix.platform == 'android'
        run: >
          wget -q
          https://dl.google.com/android/repository/android-ndk-r25c-linux.zip

          unzip -q android-ndk-r25c-linux.zip

          echo "ANDROID_NDK_ROOT=$PWD/android-ndk-r25c" >> $GITHUB_ENV

          echo "$PWD/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin"
          >> $GITHUB_PATH
      - name: Setup Android target
        if: matrix.platform == 'android'
        run: |
          case "${{ matrix.target }}" in
            aarch64-linux-android)
              echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang" >> $GITHUB_ENV
              echo "CC_aarch64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang" >> $GITHUB_ENV
              ;;
            armv7-linux-androideabi)
              echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang" >> $GITHUB_ENV
              echo "CC_armv7_linux_androideabi=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang" >> $GITHUB_ENV
              ;;
            i686-linux-android)
              echo "CARGO_TARGET_I686_LINUX_ANDROID_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android24-clang" >> $GITHUB_ENV
              echo "CC_i686_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android24-clang" >> $GITHUB_ENV
              ;;
            x86_64-linux-android)
              echo "CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang" >> $GITHUB_ENV
              echo "CC_x86_64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang" >> $GITHUB_ENV
              ;;
          esac
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: '${{ matrix.target }}'
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: >-
            ${{ runner.os }}-${{ matrix.target }}-cargo-${{
            hashFiles('**/Cargo.lock') }}
      - name: Build release
        run: 'cargo build --release --target ${{ matrix.target }}'
      - name: Strip binary (Linux/macOS)
        if: runner.os != 'Windows' && matrix.platform != 'android'
        run: >
          strip target/${{ matrix.target }}/release/${{ env.PROJECT_NAME }}${{
          matrix.extension }}
      - name: Determine version and commit
        id: vars
        run: |
          # Get tag version or use input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}

          # Get short commit hash
          SHORT_SHA=${GITHUB_SHA:0:7}

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
      - name: Create final filename
        id: filename
        run: >
          FILENAME="${PROJECT_NAME}_${{ steps.vars.outputs.version }}_${{
          matrix.platform }}_${{ matrix.arch }}_${{ steps.vars.outputs.short_sha
          }}${{ matrix.extension }}"

          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
      - name: Rename binary
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            Move-Item "target/${{ matrix.target }}/release/${{ env.PROJECT_NAME }}.exe" "target/${{ matrix.target }}/release/${{ steps.filename.outputs.filename }}"
          else
            mv "target/${{ matrix.target }}/release/${{ env.PROJECT_NAME }}" "target/${{ matrix.target }}/release/${{ steps.filename.outputs.filename }}"
          fi
      - name: Create checksum
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release
          if [ "${{ runner.os }}" = "Windows" ]; then
            # PowerShell for Windows
            $hash = (Get-FileHash "${{ steps.filename.outputs.filename }}" -Algorithm SHA256).Hash
            "$hash *${{ steps.filename.outputs.filename }}" | Out-File -FilePath "${{ steps.filename.outputs.filename }}.sha256" -Encoding ASCII
          elif [ "${{ runner.os }}" = "macOS" ]; then
            # macOS
            shasum -a 256 "${{ steps.filename.outputs.filename }}" > "${{ steps.filename.outputs.filename }}.sha256"
          else
            # Linux
            sha256sum "${{ steps.filename.outputs.filename }}" > "${{ steps.filename.outputs.filename }}.sha256"
          fi
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: '${{ matrix.platform }}-${{ matrix.arch }}'
          path: >
            target/${{ matrix.target }}/release/${{
            steps.filename.outputs.filename }}

            target/${{ matrix.target }}/release/${{
            steps.filename.outputs.filename }}.sha256
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      - name: List artifacts
        run: |
          echo "Artifacts structure:"
          find ./artifacts -type f -name "*" | sort
          echo ""
          echo "Files to be released:"
          find ./artifacts -type f ! -name "*.sha256" ! -name "*.txt" | sort
      - name: Determine release info
        id: release_info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.version }}"
          else
            TAG_NAME="${{ github.ref_name }}"
          fi

          # Get version without 'v'
          VERSION=${TAG_NAME#v}
          SHORT_SHA=${GITHUB_SHA:0:7}

          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
      - name: Generate combined SHA256 checksum
        run: >
          echo "Generating combined checksums..."

          cd artifacts

          # Collect all SHA256 files

          find . -name "*.sha256" -type f -exec cat {} \; > ALL_SHA256SUMS.txt

          echo "" >> ALL_SHA256SUMS.txt

          echo "Generated on: $(date -u)" >> ALL_SHA256SUMS.txt

          echo "Version: ${{ steps.release_info.outputs.version }}" >>
          ALL_SHA256SUMS.txt

          echo "Git SHA: ${{ github.sha }}" >> ALL_SHA256SUMS.txt

          echo "Short SHA: ${{ steps.release_info.outputs.short_sha }}" >>
          ALL_SHA256SUMS.txt
      - name: Create release notes
        run: >
          cat > release_notes.md << EOF

          # ${{ env.PROJECT_NAME }} ${{ steps.release_info.outputs.tag_name }}


          ## Multi-Platform Release


          Built for multiple platforms with standardized naming:

          \`{PKGNAME}_{VERSION}_{OS}_{ARCH}_{SHORT_SHA}.{EXT}\`


          ### Available Platforms:

          - **Linux**: x86_64, i686

          - **Windows**: x86_64, i686

          - **macOS**: x86_64, arm64

          - **Android**: aarch64, armv7, i686, x86_64


          ### File Naming Convention:

          \`\`\`

          ${{ env.PROJECT_NAME }}_${{ steps.release_info.outputs.version
          }}_{platform}_{arch}_${{ steps.release_info.outputs.short_sha
          }}{extension}

          \`\`\`


          ### Checksums


          SHA256 checksums for all binaries:


          \`\`\`

          $(cat artifacts/ALL_SHA256SUMS.txt)

          \`\`\`


          ### Installation


          **Linux/macOS:**

          \`\`\`bash

          # Download appropriate binary

          chmod +x ${{ env.PROJECT_NAME }}_*


          # Move to PATH

          sudo mv ${{ env.PROJECT_NAME }}_* /usr/local/bin/${{ env.PROJECT_NAME
          }}

          \`\`\`


          **Windows:**

          Rename the .exe file and add to your PATH.


          ### Usage


          \`\`\`bash

          ${{ env.PROJECT_NAME }} --help

          \`\`\`


          ---


          *Built with GitHub Actions - Run ID: ${{ github.run_id }}*

          EOF
      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          name: 'Release ${{ steps.release_info.outputs.tag_name }}'
          bodyFile: release_notes.md
          draft: false
          prerelease: false
          tag: '${{ steps.release_info.outputs.tag_name }}'
          artifacts: artifacts/**/*
          token: '${{ secrets.GITHUB_TOKEN }}'
