name: Android Multi-Arch Build with Cross

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [aarch64-linux-android, armv7-linux-androideabi]

    steps:
      - uses: actions/checkout@v4

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          target: ${{ matrix.target }}

      # Install cross
      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      # Setup Android NDK (harus versi yang kompatibel)
      - name: Setup Android NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q android-ndk-r25c-linux.zip
          echo "ANDROID_NDK_ROOT=$PWD/android-ndk-r25c" >> $GITHUB_ENV
          echo "$PWD/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      # Setup environment variables untuk cross
      - name: Setup cross environment
        run: |
          if [ "${{ matrix.target }}" = "aarch64-linux-android" ]; then
            echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang" >> $GITHUB_ENV
            echo "CC_aarch64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang" >> $GITHUB_ENV
            echo "CXX_aarch64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang++" >> $GITHUB_ENV
            echo "AR_aarch64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
          elif [ "${{ matrix.target }}" = "armv7-linux-androideabi" ]; then
            echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang" >> $GITHUB_ENV
            echo "CC_armv7_linux_androideabi=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang" >> $GITHUB_ENV
            echo "CXX_armv7_linux_androideabi=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang++" >> $GITHUB_ENV
            echo "AR_armv7_linux_androideabi=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
          fi

      # Build dengan cargo langsung (lebih stabil daripada cross)
      - name: Build for Android
        run: |
          cargo build --release --target ${{ matrix.target }}
          # Atau kalau mau tetap pakai cross:
          # cross build --release --target ${{ matrix.target }}

      # Prepare artifact
      - name: Prepare artifacts
        run: |
          mkdir -p artifact/${{ matrix.target }}
          # Cari binary yang dihasilkan
          find target/${{ matrix.target }}/release -maxdepth 1 -type f -executable -exec cp {} artifact/${{ matrix.target }}/ \;
          # Backup: jika tidak ada yang executable, copy semua file
          if [ -z "$(ls -A artifact/${{ matrix.target }})" ]; then
            cp target/${{ matrix.target }}/release/* artifact/${{ matrix.target }}/ 2>/dev/null || true
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: rustkpcli-${{ matrix.target }}
          path: artifact/${{ matrix.target }}/